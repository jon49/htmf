(()=>{let c=document,g=window,w=c.querySelector.bind(c),$="hf-submitting";c.addEventListener("submit",async e=>{const t=c.activeElement,r=e.target,n=e.submitter,o=n??r,i=(p(n,"formmethod")??p(r,"method")??"get").toLowerCase();if(!(i==="get"||i==="post")||[r,n].find(A("hf-ignore"))||(e.preventDefault(),A($)(n??r)))return;L(o,$,"");let l=p(n,"formaction")??p(r,"action")??"",a=new URL(l,g.location);const s={form:r,submitter:n,method:i,active:t,originator:o,action:l,url:a};try{const b=new FormData(r),v={method:i,credentials:"same-origin",headers:new Headers({"HF-Request":"true"})};if(i==="post")v.body=new URLSearchParams([...b]);else for(let u of b.entries())a.searchParams.append(...u);s.xhr={url:a,options:v},await h(o,"hf:request-before",s);const d=await fetch(a,v);if(s.xhr.response=d,await h(o,"hf:request-after",s),d.redirected){location.href=d.url;return}const f=d.headers.get("content-type");if(f?.includes("application/json")){let u=JSON.parse(await d.json());await h(o,"hf:json",{...s,data:u})}else if(f?.includes("html")){let u=await d.text(),T={...s,text:u};await h(o,"hf:swap",T),D(T)}else d.ok||await h(o,"hf:response-error",s);d.headers.has("hf-reset")&&r.reset();let m=d.headers.get("hf-events");if(m){let u=JSON.parse(m);await Promise.all(Object.entries(u).map(([T,U])=>h(o,T,U)))}}catch(b){console.error(b),L(r,"action",s.action),L(r,"method",s.method),H("submit",r)}finally{o.removeAttribute($),await h(o,"hf:completed",s)}});function D({text:e,form:t,submitter:r}){if(e==null)return;P(r,t);let n=[r,t],o=S(q("hf-target"),n),i=S(q("hf-swap"),n)??"innerHTML",l=S(q("hf-select"),n),a=r??t;l&&(i="select");let s=(o?w(o):a)??a;switch(i){case"outerHTML":case"innerHTML":s[i]=e,y(s);break;case"append":case"prepend":let b=M(e);s[i](b),y(b);break;case"beforebegin":case"afterbegin":case"beforeend":case"afterend":s.insertAdjacentHTML(i,e);break;case"oob":for(let f of M(e).childNodes){if(!(f instanceof HTMLElement))continue;let m=f.id??f.dataset.id,u=c.getElementById(m);if(!u){console.warn(`The target ${m} could not be found for swap.`);continue}u.replaceWith(f),y(f)}break;case"select":let v=Array.from((typeof e=="string"?M(e):e).querySelectorAll(l)),d=Array.from(c.querySelectorAll(l));for(let f=0;f<d.length;f++){let m=v[f],u=d[f];!u||!m||(u.replaceWith(m),y(m))}break;default:console.warn(`Unknown swap type: "${i}".`)}n.find(A("hf-scroll-ignore"))||R()}function F(e,t,r=!1){let n=Array.from(t.querySelectorAll(e)),o=Array.from(c.querySelectorAll(e));for(let i=0;i<o.length;i++){let l=n[i],a=o[i];!a||!l||(a.replaceWith(l),r||y(l))}}let j=new Set;function y(e){for(let t of e.querySelectorAll("script")){let r=t.src||t.id;if(j.has(r)){C(e,t);continue}j.add(r);const n=c.createElement("script");for(let o of t.attributes)L(n,o.name,o.value);n.appendChild(c.createTextNode(t.innerHTML)),t.replaceWith(n),C(e,n)}}function C(e,t){h(e,"hf:script-loaded",{script:S(r=>p(t,r),["src","id"])},10)}let I=null;g.addEventListener("click",e=>{I=e.target});let k;function P(e,t){let r=c.activeElement,n=r===c.body?I:r,o=S(q("hf-scroll-to"),[e,t]),i=p(n,"hf-scroll-target");i&&(n=w(i));let l=p(n?.closest("[hf-scroll-miss]"),"hf-scroll-miss"),a=p(n,"name");k={y:g.scrollY,to:o,a:{t:{y:E(n),q:n?.id&&`#${n.id}`||a&&`[name="${a}"]`},m:{y:E(w(l)),q:l}}}}function R(){let e=w("[autofocus]");if(e)return e.focus(),e.scrollIntoView({behavior:"auto",block:"center",inline:"center"});if(!k)return;let{y:t,to:r,a:{t:n,m:o}}=k,i=w(r);if(i)return i.scrollIntoView({behavior:"smooth"});let l,a=n.q&&(l=w(n.q))?n.y:o.q&&(l=w(o.q))?o.y:0;A("hf-focus-skip")(l)||(H("focus",l),H("select",l)),A("hf-scroll-skip")(c.body)||(l&&a?g.scrollTo({top:g.scrollY+E(l)-a}):g.scrollTo({top:t}))}function E(e){return e?.getBoundingClientRect().top}async function h(e,t,r,n){e.isConnected||(e=c),n&&setTimeout(()=>h(e,t,r),n);let o=e.dispatchEvent(new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:r}));if(r?.wait&&await r.wait(),!o)return Promise.reject()}function H(e,t){t?.[e]instanceof Function&&t[e]()}function S(e,t){for(let r of t){let n=e(r);if(n)return n}}function A(e){return t=>t?.hasAttribute(e)}function q(e){return t=>p(t,e)}function p(e,t){if(e?.hasAttribute(t))return e.getAttribute(t)}function L(e,t,r){e?.setAttribute(t,r)}function M(e){const t=c.createElement("template");return t.innerHTML=e,t.content}window.htmf={selectSwap:F,publish:h}})();
