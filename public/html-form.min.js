(()=>{let s=document,g=window,b=s.querySelector.bind(s),$="hf-submitting";s.addEventListener("submit",async e=>{const t=s.activeElement,r=e.target,n=e.submitter,o=n??r,l=(m(n,"formmethod")??m(r,"method")??"get").toLowerCase();if(!(l==="get"||l==="post")||[r,n].find(y("hf-ignore"))||(e.preventDefault(),y($)(n??r)))return;T(o,$,"");let i=m(n,"formaction")??m(r,"action")??"",a=new URL(i,g.location);const f={form:r,submitter:n,method:l,active:t,originator:o,action:i,url:a};try{const w=new FormData(r),A={method:l,credentials:"same-origin",headers:new Headers({"HF-Request":"true"})};if(l==="post")A.body=new URLSearchParams([...w]);else for(let c of w.entries())a.searchParams.append(...c);f.xhr={url:a,options:A},await h(o,"hf:request-before",f);const d=await fetch(a,A);if(f.xhr.response=d,await h(o,"hf:request-after",f),d.redirected){location.href=d.url;return}const q=d.headers.get("content-type");if(q?.includes("application/json")){let c=JSON.parse(await d.json());await h(o,"hf:json",{...f,data:c})}else if(q?.includes("html")){let c=await d.text(),p={...f,text:c};await h(o,"hf:swap",p),D(p)}else d.ok||await h(o,"hf:response-error",f);d.headers.has("hf-reset")&&r.reset();let u=d.headers.get("hf-events");if(u){let c=JSON.parse(u);await Promise.all(Object.entries(c).map(([p,W])=>h(o,p,W)))}}catch(w){console.error(w),T(r,"action",f.action),T(r,"method",f.method),H("submit",r)}finally{o.removeAttribute($),await h(o,"hf:completed",f)}});function D({text:e,form:t,submitter:r}){if(e==null)return;P(r,t);let n=[r,t],[o,l]=v(U("hf-target"),n),i=v(L("hf-swap"),n)??"innerHTML",a=v(L("hf-select"),n),f=r??t;a&&(i="select");let w=(o==="this"?l:o?b(o):f)??f;switch(i){case"outerHTML":case"innerHTML":w[i]=e,S(w);break;case"append":case"prepend":let A=M(e);w[i](A),S(A);break;case"beforebegin":case"afterbegin":case"beforeend":case"afterend":w.insertAdjacentHTML(i,e);break;case"oob":for(let u of M(e).childNodes){if(!(u instanceof HTMLElement))continue;let c=u.id??u.dataset.id,p=s.getElementById(c);if(!p){console.warn(`The target ${c} could not be found for swap.`);continue}p.replaceWith(u),S(u)}break;case"select":let d=Array.from((typeof e=="string"?M(e):e).querySelectorAll(a)),q=Array.from(s.querySelectorAll(a));for(let u=0;u<q.length;u++){let c=d[u],p=q[u];!p||!c||(p.replaceWith(c),S(c))}break;default:console.warn(`Unknown swap type: "${i}".`)}n.find(y("hf-scroll-ignore"))||R()}function F(e,t,r=!1){let n=Array.from(t.querySelectorAll(e)),o=Array.from(s.querySelectorAll(e));for(let l=0;l<o.length;l++){let i=n[l],a=o[l];!a||!i||(a.replaceWith(i),r||S(i))}}let j=new Set;function S(e){for(let t of e.querySelectorAll("script")){let r=t.src||t.id;if(j.has(r)){C(e,t);continue}j.add(r);const n=s.createElement("script");for(let o of t.attributes)T(n,o.name,o.value);n.appendChild(s.createTextNode(t.innerHTML)),t.replaceWith(n),C(e,n)}}function C(e,t){h(e,"hf:script-loaded",{script:v(r=>m(t,r),["src","id"])},10)}let I=null;g.addEventListener("click",e=>{I=e.target});let E;function P(e,t){let r=s.activeElement,n=r===s.body?I:r,o=v(L("hf-scroll-to"),[e,t]),l=m(n,"hf-scroll-target");l&&(n=b(l));let i=m(n?.closest("[hf-scroll-miss]"),"hf-scroll-miss"),a=m(n,"name");E={y:g.scrollY,to:o,a:{t:{y:k(n),q:n?.id&&`#${n.id}`||a&&`[name="${a}"]`},m:{y:k(b(i)),q:i}}}}function R(){let e=b("[autofocus]");if(e)return e.focus(),e.scrollIntoView({behavior:"auto",block:"center",inline:"center"});if(!E)return;let{y:t,to:r,a:{t:n,m:o}}=E,l=b(r);if(l)return l.scrollIntoView({behavior:"smooth"});let i,a=n.q&&(i=b(n.q))?n.y:o.q&&(i=b(o.q))?o.y:0;y("hf-focus-skip")(i)||(H("focus",i),H("select",i)),y("hf-scroll-skip")(s.body)||(i&&a?g.scrollTo({top:g.scrollY+k(i)-a}):g.scrollTo({top:t}))}function k(e){return e?.getBoundingClientRect().top}async function h(e,t,r,n){e.isConnected||(e=s),n&&setTimeout(()=>h(e,t,r),n);let o=e.dispatchEvent(new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:r}));if(r?.wait&&await r.wait(),!o)return Promise.reject()}function H(e,t){t?.[e]instanceof Function&&t[e]()}function v(e,t){for(let r of t){let n=e(r);if(n)return n}}function y(e){return t=>t?.hasAttribute(e)}function U(e){return t=>{if(y(e)(t))return[L(e)(t),t]}}function L(e){return t=>m(t,e)}function m(e,t){if(e?.hasAttribute(t))return e.getAttribute(t)}function T(e,t,r){e?.setAttribute(t,r)}function M(e){const t=s.createElement("template");return t.innerHTML=e,t.content}window.htmf={selectSwap:F,publish:h}})();
