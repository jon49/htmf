(()=>{let c=document,A=window,b=c.querySelector.bind(c),E="hf-submitting";c.addEventListener("submit",async e=>{const t=c.activeElement,r=e.target,n=e.submitter,o=n??r,l=[r,n],i=(p(n,"formmethod")??p(r,"method")??"get").toLowerCase();if(!(i==="get"||i==="post")||!(l.find(w("hf-target"))||l.find(w("hf-select")))||l.find(w("hf-ignore"))||(e.preventDefault(),w(E)(n??r)))return;T(o,E,"");let s=p(n,"formaction")??p(r,"action")??"",g=new URL(s,A.location);const a={form:r,submitter:n,method:i,active:t,originator:o,action:s,url:g};try{const y=new FormData(r),q={method:i,credentials:"same-origin",headers:new Headers({"HF-Request":"true"})};if(i==="post")q.body=new URLSearchParams([...y]);else for(let u of y.entries())g.searchParams.append(...u);a.xhr={url:g,options:q},await h(o,"hf:request-before",a);const d=await fetch(g,q);if(a.xhr.response=d,await h(o,"hf:request-after",a),d.redirected){location.href=d.url;return}const f=d.headers.get("content-type");if(f?.includes("application/json")){let u=JSON.parse(await d.json());await h(o,"hf:json",{...a,data:u})}else if(f?.includes("html")){let u=await d.text(),$={...a,text:u};await h(o,"hf:swap",$),F($)}else d.ok||await h(o,"hf:response-error",a);d.headers.has("hf-reset")&&r.reset();let m=d.headers.get("hf-events");if(m){let u=JSON.parse(m);await Promise.all(Object.entries(u).map(([$,Y])=>h(o,$,Y)))}}catch(y){console.error(y),T(r,"action",a.action),T(r,"method",a.method),M("submit",r)}finally{o.removeAttribute(E),await h(o,"hf:completed",a)}});function F({text:e,form:t,submitter:r}){if(e==null)return;R(r,t);let n=[r,t],[o,l]=v(W("hf-target"),n),i=v(L("hf-swap"),n)??"innerHTML",s=v(L("hf-select"),n),g=r??t;s&&(i="select");let a=(o==="this"?l:o?b(o):g)??g;switch(i){case"outerHTML":case"innerHTML":a[i]=e,S(a);break;case"append":case"prepend":let y=j(e);a[i](y),S(y);break;case"beforebegin":case"afterbegin":case"beforeend":case"afterend":a.insertAdjacentHTML(i,e);break;case"oob":for(let f of j(e).childNodes){if(!(f instanceof HTMLElement))continue;let m=f.id??f.dataset.id,u=c.getElementById(m);if(!u){console.warn(`The target ${m} could not be found for swap.`);continue}u.replaceWith(f),S(f)}break;case"select":let q=Array.from((typeof e=="string"?j(e):e).querySelectorAll(s)),d=Array.from(c.querySelectorAll(s));for(let f=0;f<d.length;f++){let m=q[f],u=d[f];!u||!m||(u.replaceWith(m),S(m))}break;default:console.warn(`Unknown swap type: "${i}".`)}n.find(w("hf-scroll-ignore"))||U()}function P(e,t,r=!1){let n=Array.from(t.querySelectorAll(e)),o=Array.from(c.querySelectorAll(e));for(let l=0;l<o.length;l++){let i=n[l],s=o[l];!s||!i||(s.replaceWith(i),r||S(i))}}let C=new Set;function S(e){for(let t of e.querySelectorAll("script")){let r=t.src||t.id;if(C.has(r)){I(e,t);continue}C.add(r);const n=c.createElement("script");for(let o of t.attributes)T(n,o.name,o.value);n.appendChild(c.createTextNode(t.innerHTML)),t.replaceWith(n),I(e,n)}}function I(e,t){h(e,"hf:script-loaded",{script:v(r=>p(t,r),["src","id"])},10)}let D=null;A.addEventListener("click",e=>{D=e.target});let k;function R(e,t){let r=c.activeElement,n=r===c.body?D:r,o=v(L("hf-scroll-to"),[e,t]),l=p(n,"hf-scroll-target");l&&(n=b(l));let i=p(n?.closest("[hf-scroll-miss]"),"hf-scroll-miss"),s=p(n,"name");k={y:A.scrollY,to:o,a:{t:{y:H(n),q:n?.id&&`#${n.id}`||s&&`[name="${s}"]`},m:{y:H(b(i)),q:i}}}}function U(){let e=b("[autofocus]");if(e)return e.focus(),e.scrollIntoView({behavior:"auto",block:"center",inline:"center"});if(!k)return;let{y:t,to:r,a:{t:n,m:o}}=k,l=b(r);if(l)return l.scrollIntoView({behavior:"smooth"});let i,s=n.q&&(i=b(n.q))?n.y:o.q&&(i=b(o.q))?o.y:0;w("hf-focus-skip")(i)||(M("focus",i),M("select",i)),w("hf-scroll-skip")(c.body)||(i&&s?A.scrollTo({top:A.scrollY+H(i)-s}):A.scrollTo({top:t}))}function H(e){return e?.getBoundingClientRect().top}async function h(e,t,r,n){e.isConnected||(e=c),n&&setTimeout(()=>h(e,t,r),n);let o=e.dispatchEvent(new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:r}));if(r?.wait&&await r.wait(),!o)return Promise.reject()}function M(e,t){t?.[e]instanceof Function&&t[e]()}function v(e,t){for(let r of t){let n=e(r);if(n)return n}}function w(e){return t=>t?.hasAttribute(e)}function W(e){return t=>{if(w(e)(t))return[L(e)(t),t]}}function L(e){return t=>p(t,e)}function p(e,t){if(e?.hasAttribute(t))return e.getAttribute(t)}function T(e,t,r){e?.setAttribute(t,r)}function j(e){const t=c.createElement("template");return t.innerHTML=e,t.content}window.htmf={selectSwap:P,publish:h}})();
