(()=>{let c=document,b=window,m=c.querySelector.bind(c),$="hf-submitting";c.addEventListener("submit",async e=>{const t=c.activeElement,r=e.target,n=e.submitter,o=n??r,i=(d(n,"formmethod")??d(r,"method")??"get").toLowerCase();if(!(i==="get"||i==="post")||[r,n].find(v("hf-ignore"))||(e.preventDefault(),v($)(r)))return;L(r,$,"");let l=d(n,"formaction")??d(r,"action")??"",s=new URL(l,b.location);const f={form:r,submitter:n,method:i,active:t,originator:o,action:l,url:s};try{const g=new FormData(r),y={method:i,credentials:"same-origin",headers:new Headers({"HF-Request":"true"})};if(i==="post")y.body=new URLSearchParams([...g]);else for(let w of g.entries())s.searchParams.append(...w);f.xhr={url:s,options:y},await u(o,"hf:request-before",f);const a=await fetch(s,y);if(f.xhr.response=a,await u(o,"hf:request-after",f),a.redirected){location.href=a.url;return}const h=a.headers.get("content-type");if(h?.includes("application/json")){let w=JSON.parse(await a.json());await u(o,"hf:json",{...f,data:w})}else if(h?.includes("html")){let w=await a.text(),T={...f,text:w};await u(o,"hf:swap",T),D(T)}else a.ok||await u(o,"hf:response-error",f);a.headers.has("hf-reset")&&r.reset();let p=a.headers.get("hf-events");if(p){let w=JSON.parse(p);await Promise.all(Object.entries(w).map(([T,U])=>u(o,T,U)))}}catch(g){console.error(g),L(r,"action",f.action),L(r,"method",f.method),H("submit",r)}finally{r.removeAttribute($),await u(o,"hf:completed",f)}});function D({text:e,form:t,submitter:r}){if(e==null)return;P(r,t);let n=[r,t],o=A(q("hf-target"),n),i=A(q("hf-swap"),n)??"innerHTML",l=A(q("hf-select"),n);l&&(i="select");let s=(o?m(o):t)??t;switch(i){case"outerHTML":case"innerHTML":s[i]=e,S(s);break;case"append":case"prepend":let f=M(e);s[i](f),S(f);break;case"beforebegin":case"afterbegin":case"beforeend":case"afterend":s.insertAdjacentHTML(i,e);break;case"oob":for(let a of M(e).childNodes){if(!(a instanceof HTMLElement))continue;let h=a.id??a.dataset.id,p=c.getElementById(h);if(!p){console.warn(`The target ${h} could not be found for swap.`);continue}p.replaceWith(a),S(a)}break;case"select":let g=Array.from((typeof e=="string"?M(e):e).querySelectorAll(l)),y=Array.from(c.querySelectorAll(l));for(let a=0;a<y.length;a++){let h=g[a],p=y[a];!p||!h||(p.replaceWith(h),S(h))}break;default:console.warn(`Unknown swap type: "${i}".`)}n.find(v("hf-scroll-ignore"))||R()}function F(e,t,r=!1){let n=Array.from(t.querySelectorAll(e)),o=Array.from(c.querySelectorAll(e));for(let i=0;i<o.length;i++){let l=n[i],s=o[i];!s||!l||(s.replaceWith(l),r||S(l))}}let j=new Set;function S(e){for(let t of e.querySelectorAll("script")){let r=t.src||t.id;if(j.has(r)){C(e,t);continue}j.add(r);const n=c.createElement("script");for(let o of t.attributes)L(n,o.name,o.value);n.appendChild(c.createTextNode(t.innerHTML)),t.replaceWith(n),C(e,n)}}function C(e,t){u(e,"hf:script-loaded",{script:A(r=>d(t,r),["src","id"])},10)}let I=null;b.addEventListener("click",e=>{I=e.target});let k;function P(e,t){let r=c.activeElement,n=r===c.body?I:r,o=A(q("hf-scroll-to"),[e,t]),i=d(n,"hf-scroll-target");i&&(n=m(i));let l=d(n?.closest("[hf-scroll-miss]"),"hf-scroll-miss"),s=d(n,"name");k={y:b.scrollY,to:o,a:{t:{y:E(n),q:n?.id&&`#${n.id}`||s&&`[name="${s}"]`},m:{y:E(m(l)),q:l}}}}function R(){let e=m("[autofocus]");if(e)return e.focus(),e.scrollIntoView({behavior:"auto",block:"center",inline:"center"});if(!k)return;let{y:t,to:r,a:{t:n,m:o}}=k,i=m(r);if(i)return i.scrollIntoView({behavior:"smooth"});let l,s=n.q&&(l=m(n.q))?n.y:o.q&&(l=m(o.q))?o.y:0;v("hf-focus-skip")(l)||(H("focus",l),H("select",l)),v("hf-scroll-skip")(c.body)||(l&&s?b.scrollTo({top:b.scrollY+E(l)-s}):b.scrollTo({top:t}))}function E(e){return e?.getBoundingClientRect().top}async function u(e,t,r,n){e.isConnected||(e=c),n&&setTimeout(()=>u(e,t,r),n);let o=e.dispatchEvent(new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:r}));if(r?.wait&&await r.wait(),!o)return Promise.reject()}function H(e,t){t?.[e]instanceof Function&&t[e]()}function A(e,t){for(let r of t){let n=e(r);if(n)return n}}function v(e){return t=>t?.hasAttribute(e)}function q(e){return t=>d(t,e)}function d(e,t){if(e?.hasAttribute(t))return e.getAttribute(t)}function L(e,t,r){e?.setAttribute(t,r)}function M(e){const t=c.createElement("template");return t.innerHTML=e,t.content}window.htmf={selectSwap:F,publish:u}})();
